<!doctype html>
<html lang="en">
  
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gallery | Asunaro Works</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1NCR09VMKR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1NCR09VMKR');
    </script>

    <!-- Pinterest Verify -->
    <meta name="p:domain_verify" content="{{ site.data.tracking.pinterest_verify }}"/>

    <!-- Google Tag Manager -->
    <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),
      dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id={{ site.data.tracking.gtm_id }}' + dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ site.data.tracking.gtm_id }}');
    </script>
    <!-- End Google Tag Manager -->

    <!-- Gallery CSS -->
    <link rel="stylesheet" href="../css/header.css"> 
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/gallery.css">

    <!-- Data loader -->
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script type="module">
      import { loadYAML } from "../js/util/yaml-loader.js";

      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      /* =========================
       *  Universal Slider
       * ========================= */
      function createSlider(container, slides = []) {
        container.innerHTML = `
          <div class="sld">
            <button class="sld__nav sld__prev" aria-label="Previous">‚Äπ</button>
            <div class="sld__viewport" aria-roledescription="carousel">
              <div class="sld__track"></div>
            </div>
            <button class="sld__nav sld__next" aria-label="Next">‚Ä∫</button>

            <div class="sld__meta">
              <h3 class="sld__title"></h3>
              <div class="sld__dots" role="tablist" aria-label="Slides"></div>
            </div>
          </div>
          <div class="sld__thumbs"></div>
        `;

        const el = {
          track:  container.querySelector(".sld__track"),
          prev:   container.querySelector(".sld__prev"),
          next:   container.querySelector(".sld__next"),
          dots:   container.querySelector(".sld__dots"),
          thumbs: container.querySelector(".sld__thumbs"),
          title:  container.querySelector(".sld__title"),
        };

        el.track.innerHTML = slides.map(s => `
          <div class="sld__slide">
            ${s.href ? `<a class="sld__link" href="${s.href}">` : `<span class="sld__link">`}
              <img src="${s.src}" alt="${s.title ?? ""}" loading="eager">
            ${s.href ? `</a>` : `</span>`}
          </div>
        `).join("");

        el.dots.innerHTML = slides.map((_, i) => `<button class="sld__dot" data-i="${i}" aria-label="Go to slide ${i+1}"></button>`).join("");
        el.thumbs.innerHTML = slides.map((s, i) => `
          <button class="sld__th" data-i="${i}" aria-label="Preview ${i+1}">
            <img src="${s.thumb || s.src}" alt="">
          </button>
        `).join("");

        let idx = 0;
        const n = slides.length;

        function update(i) {
          if (!n) return;
          idx = (i + n) % n;
          el.track.style.transform = `translateX(${-100 * idx}%)`;
          $$(".sld__dot", el.dots).forEach((d, k) => d.classList.toggle("active", k === idx));
          $$(".sld__th",  el.thumbs).forEach((t, k) => t.classList.toggle("active", k === idx));
          el.title.textContent = slides[idx]?.title || "";
        }

        el.prev.addEventListener("click", () => update(idx - 1));
        el.next.addEventListener("click", () => update(idx + 1));
        el.dots.addEventListener("click", (e) => {
          const b = e.target.closest(".sld__dot"); if (!b) return;
          update(parseInt(b.dataset.i, 10));
        });
        el.thumbs.addEventListener("click", (e) => {
          const b = e.target.closest(".sld__th"); if (!b) return;
          update(parseInt(b.dataset.i, 10));
        });

        let sx = null;
        let downAnchor = null;
        el.track.addEventListener("pointerdown", (e) => {
          downAnchor = e.target.closest("a");
          sx = e.clientX;
          if (!downAnchor) el.track.setPointerCapture(e.pointerId);
        });
        el.track.addEventListener("pointerup", (e) => {
          if (sx === null) return;
          const dx = e.clientX - sx;
          if (!downAnchor && Math.abs(dx) > 40) {
            update(idx + (dx < 0 ? 1 : -1));
          } else if (downAnchor && Math.abs(dx) < 6) {
            downAnchor.click();
          }
          sx = null;
          downAnchor = null;
        });

        update(0);
        return { update };
      }

      /* =========================
       *  Init
       * ========================= */
      async function init() {
        const data = await loadYAML("../data/gallery.yaml");

        /* ===== Top: Games ===== */
        const games = Array.isArray(data?.games) ? data.games : [];
        const gamesWrap = $("#games");
        gamesWrap.innerHTML = games.map((g, gi) => `
          <article class="g-game">
            <header class="g-game__head">
              <h2 class="g-game__title">${g.title || ""}</h2>
              ${g.subtitle ? `<p class="g-game__subtitle">${g.subtitle}</p>` : ""}
            </header>
            <div class="sld-wrap" id="game-sld-${gi}"></div>
          </article>
        `).join("");

        games.forEach((g, gi) => {
          const slides = (g.slides || []).map(s => ({
            src:   s.src,
            thumb: s.thumb || s.src,
            href:  s.href || g.cta?.href || `./${g.id}/`,
            title: s.title || g.title
          }));
          const mount = document.getElementById(`game-sld-${gi}`);

          const fallback = slides.length ? slides : [{
            src:   g.cover || g.hero || "",
            thumb: g.cover || g.hero || "",
            href:  g.cta?.href || `./${g.id}/`,
            title: g.title || ""
          }];

          createSlider(mount, fallback);
        });

        if (!games.length) {
          gamesWrap.innerHTML = `<p class="g-empty">Game exhibitions are currently in preparation.</p>`;
        }

        /* ===== Bottom: Storyboard Exhibits ===== */
        const exhibits = Array.isArray(data?.exhibits)
          ? data.exhibits
          : Array.isArray(data?.gallery) ? data.gallery : [];
        const exWrap = $("#exhibits");

        exWrap.innerHTML = exhibits.map((x, xi) => `
          <section class="g-exhibit">
            <h3 class="g-exhibit__title">${x.title || ""}</h3>
            <div class="sld-wrap" id="ex-sld-${xi}"></div>
          </section>
        `).join("");

        exhibits.forEach((x, xi) => {
          const slidesSrc = (x.slides && x.slides.length)
            ? x.slides
            : (x.cover ? [{ src: x.cover, title: x.title }] : []);

          const slides = slidesSrc.map((s, i) => {
            const href =
              (i === 0)
                ? "../gallery/Usako_and_Kameko/"
              : (i === 1)
                ? "../gallery/renewal-of-the-forest-covenant/"
              : (i === 2)
                ? "../gallery/Risko/"
              : (i === 3)
                ? "../gallery/lili_and_kaede/" 
              : (s.href ?? x?.cta?.href ?? (x?.id ? `./${x.id}/` : null));
              
            return {
              src:   s.src,
              thumb: s.thumb || s.src,
              href,
              title: s.title || x.title,
            };
          });

          const mount = document.getElementById(`ex-sld-${xi}`);
          createSlider(mount, slides);
        });

        if (!exhibits.length) {
          exWrap.innerHTML = `<p class="g-empty">Exhibits are currently in preparation.</p>`;
        }

      }

      init().catch(err => {
        console.error(err);
        const el = document.getElementById("games");
        if (el) el.innerHTML = `<p class="g-error">Failed to load data.</p>`;
      });
    </script>
  </head>

  <body data-page="gallery">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5SJ395RM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <header class="nav">
    <a class="brand" href="../">Asunaro Works</a>
    <a class="go-up" href="../" title="‰∏Ä„Å§‰∏ä„ÅÆÈöé„Å∏">‚è∂</a>
    <nav>
      <a href="../gallery/">Gallery</a>
      <a href="../about/">About</a>
      <a href="../process/">Process</a>
      <a href="../contact/">Contact</a>
      <a href="../link/">Link</a>
      <a href="../sitemap/">Sitemap</a>
      <a href="../goods/">Goods</a>
      <a href="https://asunaro0000.github.io/asunaro0000.homepage/gallery/">üåê JP</a>
    </nav>
  </header>

    <main class="g-wrap">
      <!-- Exhibits -->
      <section class="g-block">
        <h2 class="g-block__title">Works ‚Äî Storyboard Collections</h2>
        <p class="g-block__lead">
          Visual works arranged along the flow of each story.  
          Follow the atmosphere, light, and emotional transitions through each scene.
        </p>
        <div id="exhibits" class="g-stack"></div>
      </section>
      <!-- Games -->
      <section class="g-block">
        <h1 class="g-block__title">„Ää Games „Äã</h1>
        <p class="g-block__lead">
          Game exhibitions. Click an image to visit each project.
        </p>
        <div id="games" class="g-stack"></div>
      </section>
    </main>

    <footer>¬© 2025 Asunaro Works. All rights reserved.</footer>
    <script type="module" src="../js/extensions/nav-toggle.js"></script>
  </body>
</html>
