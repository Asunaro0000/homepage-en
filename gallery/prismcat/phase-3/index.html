<!doctype html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1NCR09VMKR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1NCR09VMKR');
  </script>
   <!-- Pinterest Verify -->
  <meta name="p:domain_verify" content="{{ site.data.tracking.pinterest_verify }}"/>

  <!-- Google Tag Manager -->
  <script>
  (function(w,d,s,l,i){
    w[l]=w[l]||[];
    w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),
    dl=l!='dataLayer'?'&l='+l:'';
    j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id={{ site.data.tracking.gtm_id }}' + dl;
    f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','{{ site.data.tracking.gtm_id }}');
  </script>
  <!-- End Google Tag Manager -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PrismCat â€“ phase-3</title>

  <!-- /gallery/prismcat/phase-3/ ã‹ã‚‰å…±é€šCSSã¸ã¯ ../../../ -->
  <link rel="stylesheet" href="../../../css/style.css"/>
  <link rel="stylesheet" href="../../../css/header.css">
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5SJ395RM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <header class="nav">
    <a class="brand" href="../../../">Asunaro Works</a>
    <a class="go-up" href="../" title="ä¸€ã¤ä¸Šã®éšã¸">â¶</a>
    <nav>
      <a href="../../../gallery/">Gallery</a>
      <a href="../../../about/">About</a>
      <a href="../../../process/">Process</a>
      <a href="../../../contact/">Contact</a>
      <a href="../../../link/">Link</a>
      <a href="../../../sitemap/">Sitemap</a>
      <a href="../../../goods/">Goods</a>
      <a href="https://asunaro0000.github.io/asunaro0000.homepage/gallery/prismcat/phase-3/">ğŸŒ JP</a>
    </nav>
  </header>

  <main class="section">
    <div id="stage" class="figure" aria-live="polite"></div>
    <div id="caption" class="caption"></div>

    <div class="toolbar" style="margin:12px 0 8px; display:flex; gap:10px;">
      <button id="playToggle" class="btn" type="button" aria-pressed="false" aria-label="Auto slide toggle">â–¶ Auto</button>
      <button id="bgmToggle"  class="btn" type="button" aria-pressed="false" aria-label="BGM toggle">â™ª BGM</button>
    </div>

    <h2 style="margin:18px 0 10px">Album</h2>
    <div class="slider" id="slider" aria-roledescription="carousel">
      <button class="nav prev" type="button" aria-label="Previous">â€¹</button>
      <div class="track" id="track" style="touch-action:pan-y;"></div>
      <button class="nav next" type="button" aria-label="Next">â€º</button>
      <div class="dots" id="dots" role="tablist" aria-label="Slides"></div>
    </div>

    <div id="thumbs" class="thumbs" style="margin-top:8px;"></div>

    <p style="margin-top:16px">
      <a class="btn" href="../">â† Back to Series</a>
    </p>
  </main>

  <footer>Â© 2025 Asunaro Works. All rights reserved.</footer>

  <script type="module">
    import { loadYAML } from '../../../js/util/yaml-loader.js';

    const DATA_URL = '../../../data/series/prismcat.yaml';
    const PHASE_ID = 'phase-3';

    // YAMLå†…ã® 'assets/...' ã‚„ '/assets/...' ã‚’ phaseãƒšãƒ¼ã‚¸ç”¨ã« '../assets/...' ã¸è£œæ­£
    const urlFromPhase = (p) => p ? '../' + String(p).replace(/^\/+/, '') : p;

    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const el = {
      stage:   $('#stage'),
      caption: $('#caption'),
      play:    $('#playToggle'),
      bgm:     $('#bgmToggle'),
      slider:  $('#slider'),
      track:   $('#track'),
      dots:    $('#dots'),
      thumbs:  $('#thumbs'),
      prev:    $('.prev'),
      next:    $('.next'),
    };

    let idx = 0, items = [], timer = null, audio = null;

    function setDotsActive(i){
      $$('#dots .dot').forEach((d,k)=>d.classList.toggle('active',k===i));
      $$('#thumbs .th').forEach((t,k)=>t.classList.toggle('active',k===i));
    }
    function go(n){
      if(!items.length) return;
      idx = (n + items.length) % items.length;
      el.track.style.transform = `translateX(${ -100 * idx }%)`;
      setDotsActive(idx);
    }
    function play(){
      if(timer || items.length<=1) return;
      el.play.textContent = 'â¸ Auto';
      el.play.setAttribute('aria-pressed','true');
      timer = setInterval(()=>go(idx+1), 4000);
    }
    function pause(){
      if(!timer) return;
      clearInterval(timer); timer=null;
      el.play.textContent = 'â–¶ Auto';
      el.play.setAttribute('aria-pressed','false');
    }

    async function init(){
      const spec = await loadYAML(DATA_URL);
      const phases = spec?.series?.phases || spec?.phases || [];
      const p = phases.find(x => String(x.id)===PHASE_ID || String(x.id)==='3' || x.key===PHASE_ID);
      if(!p) throw new Error('phase-3 not found in YAML');

      // èƒŒæ™¯ã¯æœªå‡ºåŠ›ï¼ˆå…ƒã®ä»•æ§˜ã‚’è¸è¥²ï¼‰
      el.stage.innerHTML   = '';
      el.caption.innerHTML = `<h1>${p.title ?? 'Phase 3'}</h1><p>${p.caption ?? ''}</p>`;

      // ã‚¢ãƒ«ãƒãƒ ï¼ˆURLã¯å¿…ãšè£œæ­£ã—ã¦ã‹ã‚‰ä½¿ã†ï¼‰
      items = Array.isArray(p.album) ? p.album : [];
      el.track.innerHTML = items.map(i=>`
        <div class="slide">
          <img src="${urlFromPhase(i.src)}" alt="${i.title ?? ''}">
          <div class="legend">
            <h3>${i.title ?? ''}</h3>
            <p>${i.text  ?? ''}</p>
          </div>
        </div>`).join('');

      el.dots.innerHTML = items.map((_,k)=>
        `<button class="dot" role="tab" data-i="${k}" aria-label="Go to slide ${k+1}"></button>`
      ).join('');

      el.thumbs.innerHTML = items.map((i,k)=>`
        <button class="th" data-i="${k}" aria-label="Preview ${k+1}">
          <img src="${urlFromPhase(i.src)}" alt="">
        </button>`).join('');

      const navDisabled = items.length<=1;
      [el.prev, el.next, el.dots, el.thumbs, el.play].forEach(b=>{ if(b) b.disabled = navDisabled; });

      el.prev?.addEventListener('click', ()=>{ pause(); go(idx-1); });
      el.next?.addEventListener('click', ()=>{ pause(); go(idx+1); });
      el.dots?.addEventListener('click', e=>{ const b=e.target.closest('.dot'); if(b){ pause(); go(+b.dataset.i); }});
      el.thumbs?.addEventListener('click', e=>{ const b=e.target.closest('.th');  if(b){ pause(); go(+b.dataset.i); }});

      // ã‚¹ãƒ¯ã‚¤ãƒ—
      let sx=null;
      el.track.addEventListener('pointerdown', e=>{ sx=e.clientX; el.track.setPointerCapture(e.pointerId); pause(); });
      el.track.addEventListener('pointerup',   e=>{ if(sx===null) return; const dx=e.clientX-sx; if(Math.abs(dx)>40) go(idx+(dx<0?1:-1)); sx=null; });

      // ã‚­ãƒ¼æ“ä½œ
      window.addEventListener('keydown', e=>{
        if(e.key==='ArrowLeft'){  pause(); go(idx-1); }
        if(e.key==='ArrowRight'){ pause(); go(idx+1); }
      });

      // BGMï¼ˆã“ã‚Œã‚‚è£œæ­£ã—ã¦ã‹ã‚‰ï¼‰
      if(p.bgm){
        audio = new Audio(urlFromPhase(p.bgm));
        audio.loop = true; audio.volume = 0.25;
        el.bgm?.addEventListener('click', async ()=>{
          try{
            if(audio.paused){ await audio.play(); el.bgm.textContent='â™ª BGM: ON'; el.bgm.setAttribute('aria-pressed','true'); }
            else{ audio.pause(); el.bgm.textContent='â™ª BGM'; el.bgm.setAttribute('aria-pressed','false'); }
          }catch(err){ console.warn('Autoplay blocked or audio error:', err); }
        });
      }else{
        el.bgm?.setAttribute('disabled','true');
      }

      go(0);
    }

    el.play.addEventListener('click', ()=> (timer ? pause() : play()));

    init().catch(err=>{
      console.error(err);
      const m=document.createElement('p');
      m.style.color='#f66';
      m.textContent='èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      el.caption.appendChild(m);
    });
  </script>
  <script type="module" src="../../../js/extensions/nav-toggle.js"></script>

</body>
</html>
